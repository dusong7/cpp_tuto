#include <string.h>
#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>

/* TGA header */
#pragma pack(push, 1)
typedef struct
{
	uint8_t id_lenght;
	uint8_t colormap_type;
	uint8_t image_type;

	uint16_t cm_first_entry;
	uint16_t cm_length;
	uint8_t cm_size;

	uint16_t x_origin;
	uint16_t y_origin;

	uint16_t width;
	uint16_t height;

	uint8_t pixel_depth;
	uint8_t image_descriptor;

	//uint8_t data[0];
} TGA;
#pragma pack(pop)

void* TGA_GET_DATA(TGA *tga)
{
	if (tga == NULL)
	{
		return NULL;
	}

	uint8_t* data = ((uint8_t*)&tga[1]) + tga->id_lenght;
	return (void*)data;
}

bool ReadDataFromFile(FILE * f, void* buffer, int n)
{
	int idx;
	int ret;
	int nbTries;
	uint8_t* data = (uint8_t*)buffer;

	idx = 0;
	nbTries = 99;
	while (n > 0)
	{
		ret = fread((void*)&data[idx], 1, n, f);
		if (ret <= 0)
		{
			if (--nbTries == 0)
			{
				break;
			}
		}
		else
		{
			n -= ret;
			idx += ret;
		}
	}

	return n == 0;
}

void* LoadFILE(const char * filename, size_t & size)
{
	FILE* f;
	uint8_t* data;
	int n;
	int ret;
	int idx;
	int nbTry;	

	data = NULL;
	f = fopen(filename, "rb");
	if (f == NULL)
	{
		printf("[LoadFILE]  failed to open file %s\n", filename);
		goto err;
	}

	// get size
	fseek(f, 0 ,SEEK_END);
	n = ftell(f);
	size = n;
	fseek(f, 0 ,SEEK_SET);

	data = (uint8_t*)malloc(n);
	if (data == NULL)
	{
		printf("[LoadFILE] failed to alloc %d bytes\n", n);
		goto err;
	}

	if (!ReadDataFromFile(f, data, n))
	{
		printf("[LoadFILE] failed the file fully %s\n", filename);
		goto err;
	}

	return (void*)data;
err:
	size = 0;

	if (data != NULL)
	{
		free((void*)data);
	}

	if (f != NULL)
	{
		fclose(f);
	}
	return NULL;
}

bool IsBigEndian()
{
	const int n = 1;
	// little endian if true
	return (*(char *)&n == 0);
}

uint16_t Swap16(uint16_t n)
{
	return (n>> 8) | (n << 8);;
}

TGA* LoadTGA(const char * filename)
{
	size_t size;
	TGA * tga;

	tga = (TGA*)LoadFILE(filename, size);
	if (tga == NULL)
	{
		printf("[LoadTGA] file %s file error\n", filename);
		free(tga);
		return NULL;
	}

	if (IsBigEndian())
	{
		tga->cm_first_entry = Swap16(tga->cm_first_entry);
		tga->cm_length = Swap16(tga->cm_length);

		tga->x_origin = Swap16(tga->x_origin);
		tga->y_origin = Swap16(tga->y_origin);

		tga->width = Swap16(tga->width);
		tga->height = Swap16(tga->height);
    	}

	if (tga->image_type != 2 && tga->pixel_depth != 24 && tga->pixel_depth != 32)
	{
		printf("[LoadTGA] (%s) pixel depth error only 24 bits or 32 bits tga is accepted (%d)\n", filename, (int)tga->pixel_depth);
		free(tga);
		return NULL;
	}

	size_t optimalSize = sizeof(TGA) + tga->id_lenght + tga->width * tga->height * tga->pixel_depth / 8;
	if (size < optimalSize) // Photoshop add information at the end of TGA image
	{
		printf("[LoadTGA] file %s bad filesize\n", filename);
		free(tga);
		return NULL;
	}

	return tga;
}

void printTGA(TGA * tga)
{
	const char* palette = "  .:;;#";
	const int palette_max = strlen(palette) - 1;

	uint8_t* tga_data = (uint8_t*)TGA_GET_DATA(tga);
	uint8_t bytesPerPixels = tga->pixel_depth / 8;
	for (int y = (int)tga->height - 1; y >= 0; y--)
	{
		uint8_t* pixels = tga_data + y * tga->width * bytesPerPixels; 
		for (unsigned int x = 0; x < (int)tga->width; x++)
		{
			uint8_t c = (*(pixels + 0) + *(pixels + 1) + *(pixels + 2)) / 3;
			unsigned int palette_idx = (c * palette_max) / 255; 
			putchar(palette[palette_idx]); 
			pixels += bytesPerPixels;
		}
		putchar('\n');
	}
}

int main(int argc, char ** argv)
{
	const char * filename;
	TGA* tga;

	if (argc != 2)
	{
		printf("error need 1 param\n");
		printf("usage : ./06_testimage2ascii image.tga\n");
		return -1;
	}

	filename = argv[1];
	tga = LoadTGA(filename);
	if (tga == NULL)
	{
		printf("error : open or load tga file failed (%s)\n", filename);
		return -2;
	}

	printTGA(tga);
	free((void*)tga);
	return 0;
}

/*
> ./06_image2ascii pika.tga
output:
############;;;;;;;;;;;##;;;;;;;;;;;;;;;;;;;;#####;;;;;;;;;;;;;##############
###########;;;;;;;;;;####;;;;;;;;;;;;;;;;;;;#####;;;;;;;;;;;;;###############
##########;;;;;;;;;;;###;;;;;;;;;;;;;;;;;;;######;;;;;;;;;;;;################
#########;;;;;;;;;;###;;;;;;;;;;;;;;;;;;;;######;;;;;;;;;;;;#################
########;;;;;;;;;;####;;;;;;;;;;;;;;;;;;;######;;;;;;;;;;;;##################
#######;;;;;;;;;;;##;;;;;;;;;;;;;;;;;;;;######;;;;;;;;;;;;#################;;
######;;;;;;;;;;####;;;;;;;;;;;;;;;;;;;######;;;;;;;;;;;;##################;;
####;;;;;;;;;;;;###;;;;;;;;;;;;;;;;;;;######;;;;;;;;;;;;#################;#;;
####;;;;;;;;;;;##;;;;;;;;;;;;;;;;;;;;######;;;;;;;;;;;;##################;;;;
##;;;;;;;;;;;####;;;;;;;;;;;;;;;;;;;######;;;;;;;;;;;;##################;;;;;
#;;;;;;;;;;;;###;;;;;;;;;;;;;;;;;;;######;;;;;;;;;;;;###################;;;;;
;;;;;;;;;;;###;;;;;;;;;;;;;;;;;;;;######;;;;;;;;;;;;##########;;;;;;;#;;;;;;;
;;;;;;;;;;####;;;;;;;;;;;;;;;;;;;######;;;;;;;;;;;;###########;;;  ;;#;;;;;;;
;;;;;;;;;;##;;;;;;;;;;;;;;;;;;;;######;;;;;;;;;;;;##########;;;;   ;;;;;;;;;;
;;;;;;;;##;;;;;;;;;;;;;;;;;;;;;######;;;;;;;;;;;;###########;;;    :;;;;;;;;;
;;;;;;;;#;;;;;;;;;;;;;;;;;;;;;######;;;;;;;;;;;;###########;;;     .;;;;;;;;;
;;;;;;;##;;;  .:;;;;;;;;;;;;;######;;;;;;;;;;;;###########;;;.     .;;;;;;;;#
;;;;;####;;;      :;;;;;;;;;######;;;;;;;;;;;;############;;:       ;;;;;;;##
;;;;;##;;;;;        :;;;;;;######;;;;;;;;;;;;############;;;        ;;;;;;###
;;;###;;;;;;:         :;;;;#####;;;;;;;;;;;;#############;;.       .;;;;;####
;;####;;;;;;;        .  ;;;;###;;;;;;;;;;;;##############;; :.     .;;;;#####
;;#;;;;;;;;;;:       .:. :;;;#;;;;;;;;;;;;##############;;: ::     :;;;######
###;;;;;;;;;;;       .::: .;;;;;;;;;;;;;;###############;; .::.    ;;;#######
#;#;;;;;;;;;;;;      .::::  ;;;;;;;;;;;;###############;;; ::::    ;;;#######
#;;;;;;;;;;;;;;:     .:::::. ;;;;;;;;;;################;; .::::    ;;########
#;;;;;;;;;;;;;;;.    .::::::. ;;;;;;;;###########;;;;##;; :::::.  .;;########
;;;;;;;;;;;;;;;;;     :::::::: ;;;;;;##########;;;;;;;;;: ::::::  ;;;########
;;;;;;;;;;;;;;;;;;    ::::::::: ;;;;##########;;;;;;;;;;..::::::  ;;#########
;;;;;;;;;;;;;;;;;;;   :::::::::. ;;;###;;;;;;;;;;;;;;;;; ::::::: .;;#########
;;;;;;;;;;;;;;;;;;;;  .:::::::::..;;;;;;;;;;;;;;;;;;;;;; ::::::: ;;;#########
;;;;;;;;;;;;;;;##;;;;. :::::::::: ;;;;;.        .:;;;;;;.::::::. ;;;#########
;;;;;;;;;;;;;;####;;;;: :::::::::: ;.  .::::::::.   ;;;:.:::::: ;;;##########
;;;;;;;;;;;;;######;;;;; .::::::::  :::::::::::::::. .;.::::::: ;;;##########
:  .;;;;;;;;######;;;;;;;: .:::::::::::::::::::::::::.  :::::: ;;;###########
; :.  .;;;;;;####;;;;;;;;;;. :::::::::::::::::::::::::: .::::..;;;###########
; ::::.  :;;;;;#;;;;;;;;;;;;;. .::::::::::::::::::::::::::::: ;;;############
; :::::::  .;;;;;;;;;;;;;;;;;..::::::::::::::::::::::::::::: ;;;#############
; :::::::::.  ;;;;;;;;;;;;;;: ::::::::::::::::::::::::::::. :;;##############
; :::::::::::.  ;;;;;;;;;;;; :::::::   .::::::::::::::::::: ;;;##############
;..::::::::::::.  ;;;;;;#;;..:::::: .;; .::::::::::::::::::.:;;##############
;: :::::::::::::::  ;;;;;;; ::::::  :;;. ::::::::::::: . ::: ;;;#############
;; ::::::::::::::::: .;;;;: ::::::   ::  :::::::::::: ;;; ::.:;;#############
;; ::::::::::::::::::. .;;..::::::       :::::::::::: ;;: ::: ;;###########;;
;; ::::::::::::::::::::. : .::::::.     .:::::::::::.     .:: ;;###########;;
;;.::::::::::::::::::::::  ::::::::.   .:::::::::::::     ::: ;;;########;#;;
;;:.:::::::::::::::::::::: :::...::::::::::::::.:::::     :::.:;;########;;;;
;;; :::::::::::::::::::::: ::......:::::::::::::::::::. .::::.:;;#######;;;;;
;;; :::::::::::::::::::::: ::......::::: .:::::::::::::::::::.:;;######;;;;;;
;;; :::::::::::::::::::: . .........:::::        .: ::::::.:: :;;#####;;;;;;;
#;; ::::::::::::::::::  . . ........::::::         :::::....: ;;;#####;;;;;;;
;;;:.::::::::::::::::. :::: ........::::::        :::::...... ;;####;;;;;;;;;
;;;; :::::::::::::::. .:::::  .....::::::: ...    :::::..... .;;###;;;;;;;;;;
;;;; :::::::::::::::  :::::::  ...::::::::. ...  :::::...... ;;;###;;;;;;;;;;
;;;; ::::::::::::::: :::::::::  .:::::::::: ... .:::::..... .;;##;;;;;;;;;;;;
;;;;..::::::::::::::..::::::::: .::::::::::.   .::::::..... ;;;##;;;;;;;;;;;;
;;;;;:   .::::::::::: :::::::::: .:::::::::::.::::::::.... ;;;;;;;;;;;;;;;;;#
;;;;;;;;;:.  .:::::::..:::::::::: ::::::::::::::::::::::. ;;;;;;;;;;;;;;;;;##
;;;;;;;;;;;;;:.  .:::: ::::::::::: ::::::::::::::::::::  :;;;;;;;;;;;;;;;;###
;;;;;#####;;;;;;;.  .: :::::::::::..:::::::::::::::::. ...     .    .;;;;####
;;;;#########;;;;;;;:   ::::::::::: ::::::::::::::::::::::::::::::::.;;;#####
;;;#############;;;;; : ::::::::::::.::::::::::::::::::::::::::::::: :;######
;;##############;;;; :: .:::::::::::::::::::::::::::::::::::::::::::.:;######
;###############;;; .::: ::::::::::::::::::::::::::::::::::::::::::: ;;######
##############;;;; .::::..::::::::::::::::::::::::::::::: ::::::::: ;;;######
#############;;;;..:::::  ::::::::::::::::::::::::::::::: :::::::: ;;;;######
#############;;;..::::: :; :::::::::::::::::::::::::::::: ::::::. ;;;;#######
#############;;: ::::: .;;: :::::::::::::::::::::::::::::..::::  ;;;;########
#############;;;; .:::: :;;:.::::::::::::::::::::::::::::. ::  :;;;;#########
#############;;;;;. :::: :;; :::::::::::::::::::::::::::::   :;;;;;#########;
############;;;;;;;; .:::..;.::::::::::::::::::::::::::::: ;;;;;;###########;
############;;;;;;;;;..:::. .:::::::::::::::::::::::::::::.:;;;###########;;;
##########;;;;;;;;;;; ::::.  ::::::::::::::::::::::::::::::.;;############;;;
#########;;;;;;;;;;: :::: .. .::::::::::::::::::::::::::::: ;;;##########;;;;
#########;;;;;;;;;. :::: :;  .::::::::::::::::::::::::::::: ;;;#########;;;;;
#######;;;;;;;;;; .:::: ;;;  ::::::::::::::::::::::::::::::..;;########;;;;;;
######;;;;;;;;;;;;  :::  ;; :::::::::::::::::::::::::::::::: ;;#######;;;;;;;
####;;;;;;;;;;;;;;;: ..   ..:::::::::::::::::::::::::::::::: ;;;#####;;;;;;;;
###;;;;;;;;;;;;##;;;;:     .::::::::::::::::::::::::::::::::.:;;####;;;;;;;;;
##;;;;;;;;;;;;####;;;;;     ::::::::::::::::::::::::::::::::..;;###;;;;;;;;;;
#;;;;;;;;;;;;#####;;;;      .:::::::::::::::::::::::::::::::: ;;##;;;;;;;;;;;
#;;;;;;;;;;;######;;;        :::::::::::::::::::::::::::::::: ;;#;;;;;;;;;;;;
;;;;;;;;;;;#######;;         :::::::::::::::::::::::::::::::: ;;;;;;;;;;;;;;;
;;;;;;;;;;########;;;.      ::::::::::::::::::::::::::::::::: ;;;;;;;;;;;;;;;
;;;;;;;;;#########;;;;;    :::::::::::::::::::::::::::::::::: ;;;;;;;;;;;;;;;
;;;;;;;;############;;;;:  :::::::::::::::::::::::::::::::::. ;;;;;;;;;;;;;;;
;;;;;;;###############;;;; ::::::::::::::::::::::::::::::::: .;;;;;;;;;;;;;;;
;;;;;;#################;;; ::::::::::::::::::::::::::::::::: ;;;;;;;;;;;;;;;;
;;;;;###################;;. ::::::::::::::::::::::::::::::: :;;;;;;;;;;;;;;;#
;;;;####################;;; :::::::::::::::::::::::::::::. :;;;;;;;;;;;;;;;;#
;;;######################;;: ::::::::::::::::::::::::::.   .;;;;;;;;;;;;;;;##
;;#######################;;;  :::::::::::..             .::..;;;;;;;;;;;;;###
;########################;;; .  .::::.   .:;;;;;;;;; .:::::...;;;;;;;;;;;####
*/
